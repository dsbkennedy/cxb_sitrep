---
title: "Cox's Bazar - Epidemiological Summary"
params:
  subtitle:
    label: "Subtitle"
    input: text
    value: "Confidential and Sensitive"
  date:
    label: "Date produced"
    input: text
    value: !r paste0("Created on ", format(Sys.time(), '%d %B, %Y'))
  organism:
    label: "Organism"
    input: text
    value: "COVID-19 (SARS-CoV-2)"
  response:
    label: "Response type"
    input: text
    value: "standard national"
output:
  word_document:
    fig_height: 3
    fig_width: 8
    reference_docx: PHE_template.docx
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, error=TRUE)
options(knitr.kable.NA = "Unknown")
```

```{r load libraries/functions, include=FALSE, message = FALSE}

library(magrittr)
library(tidyverse)
library(lubridate)
library(readxl)
library(sf)
library(epitrix)
library(dplyr)
library(kableExtra)
library(EpiCurve) 
library(epitools) 
library(flextable)
library(officer)
library(coarseDataTools)
library(janitor)
library(here)
library(googlesheets4)
library(purrr)
library(scales)

#library(incidence)

#install.packages("zip")
#install.packages("flextable")
#install.packages("officer")
#install.packages("coarseDataTools")
#install.packages("janitor")
#install.packages("here")
#install.packages("incidence")

#CHANGE HERE:
#setwd("U:\\CxB - Virtual Deployment\\")

#Automatic load in of the Google Docs line list 
sheet_names <- c('fdmn', 'ari_ili', 'testing')
gdrive_link <- "1Gnutu0OxxFJJq73KUzLQzHZHteFwpQP-B_tXct7OGwE"
gs4_deauth()
gsheet_data <- map(sheet_names, ~read_sheet(gdrive_link, sheet=.)) %>%  set_names(sheet_names)
### FDMN
FDMN_Only <- gsheet_data$fdmn
### ARI/ILI
ari_ili<- gsheet_data$ari_ili
### Testing data
Testing<- gsheet_data$testing

# MANUALLY DOWNLOAD AND SAVE USING THE CODE HERE IF GOOGLE LINE LIST AUTO-PULL ABOVE BREAKS:
# FDMN_Only<- read_excel("Data/20200804_rst_cov_cxb.xlsx", sheet ="fdmn")
# Testing<- read_excel("Data/20200804_rst_cov_cxb.xlsx", sheet ="testing")
# ari_ili<-read_excel("Data/20200804_rst_cov_cxb.xlsx", sheet ="ari_ili")

# Manually load in the UNHCR data on population 
#population<-read_excel("Data/20200630_population_FDMN.xlsx")

```

```{r, include=FALSE, message = FALSE}

# CLEANING

#cleaning the column names - changing to all lower cases and spaces separated by _
cleaned_colnames <- epitrix::clean_labels(colnames(FDMN_Only))
colnames(FDMN_Only) <- cleaned_colnames
rm(cleaned_colnames)

#Remove blank rows - removing rows where all the entries are "NA"  
FDMN_Only<- FDMN_Only %>%
  filter_all(any_vars(!is.na(.)))

# Set number of cases [FDMN]
n_cases_FDMN<-nrow(FDMN_Only)

# Replacing all "NA"s in the Severity of disease section with "Unknown"
FDMN_Only$severity_of_disease[is.na(FDMN_Only$severity_of_disease)] <- 'Unknown'

## CLEANING TESTING DATA

#cleaning the column names
cleaned_colnames <- epitrix::clean_labels(colnames(Testing))
colnames(Testing) <- cleaned_colnames
rm(cleaned_colnames)

#Remove blank rows - removing rows where all the entries are "NA"  
Testing<- Testing %>%
  filter_all(any_vars(!is.na(.)))

#cleaning the column names
cleaned_colnames <- epitrix::clean_labels(colnames(ari_ili))
colnames(ari_ili) <- cleaned_colnames
rm(cleaned_colnames)

# Remove data which have "NA" in the date column
TestingClean<- subset(Testing, date!="Total") 

#Transforming to dates
TestingClean$date<-excel_numeric_to_date(as.numeric(as.character(TestingClean$date)), date_system = "modern")    

#Remove blank rows - removing rows where all the entries are "NA"  
TestingClean<- TestingClean %>%
  filter_all(any_vars(!is.na(.)))

#For graphs
test_nationality <- TestingClean %>%
  filter(!date %in% c('NULL', 'Total')) %>%
  mutate(date_format=excel_numeric_to_date(as.numeric(date))) %>%
  select(-date) %>%
  pivot_longer(-date_format)

#cut into age groups
FDMN_Only$agegp<-cut(FDMN_Only$age_in_years,
              breaks = c(0, 16, 20, 30, 40, 50, 60, 70, 150), 
              labels = c("0-15", "16-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70+"),
              right=F)

# The camp name is imported as a numeric rather than as a factor and as a list
FDMN_Only$camp_of_residence<-as.factor(unlist(FDMN_Only$camp_of_residence))
str(FDMN_Only)


```

```{r, include=FALSE, message = FALSE}

# SETTTING NUMBERS FOR THE SUMMARY
#Set CRF
Outcome_Proportions<- FDMN_Only %>%
  group_by(`30_day_outcome`) %>%
  summarise(count=n())

Outcome_Proportions<- Outcome_Proportions%>%
  adorn_totals("row")

Proportions_2<-Outcome_Proportions$count/ n_cases_FDMN *100
Outcome_Proportions['Percentage'] = Proportions_2

# outcomes at 30 days
sum_tab_30<- as.data.frame(table(FDMN_Only$`30_day_outcome`))
names(sum_tab_30) <- c('Outcome at 30 days','Count')
FlexTab_outcomesat30<-flextable(sum_tab_30)
FlexTab_outcomesat30<-autofit(FlexTab_outcomesat30)

#Deaths at 30 days follow up
deathscount<-sum_tab_30[1,2]

#Set CRF = death/all results (column 3, row 1)
CRF<-round(Outcome_Proportions[1,3], 1)

#Set number of camps with at least one confirmed case
CasesCamp<- FDMN_Only %>%
  group_by(camp_of_residence) %>%
  summarise(count=n())
CasesCampVal<-unique(CasesCamp$camp_of_residence)
length(CasesCampVal)

CampsWithCases<-length(CasesCampVal)

# Median age of cases (min and max)
medianage<-median(FDMN_Only$age_in_years)
RangeUpper<-max(FDMN_Only$age_in_years)
RangeLow<-min(FDMN_Only$age_in_years)

# Sex
Sex<- FDMN_Only %>%
  group_by(sex) %>%
  summarise(count=n())

# Cases split by sex
Male<-Sex[2,2]
Female<-Sex[1,2]

#Male and Female - %s
Male_Prop<-round(sum(Male/(Male+Female)*100), 1)
Female_Prop<-round(sum(Female/(Male+Female)*100), 1)

#Setting time frames used in this report
first_date <- min(TestingClean$date) 
last_date <- today() 
ThisWeek<-ISOweek(today()) 
LastWeek<-ISOweek(today()-7) 

FDMN_Only$ISOweek <-date2ISOweek(FDMN_Only$date_of_case_detection)

LastWeekCases<- FDMN_Only %>% 
  filter(ISOweek <=(LastWeek)) %>% 
  summarise(count=n())
DifferenceLastWeek<-sum(n_cases_FDMN - LastWeekCases)  

# Fixing Typos
FDMN_Only <- FDMN_Only %>% 
  mutate (camp_of_residence=ifelse(camp_of_residence=="Nyapara RC", "Nayapara RC",camp_of_residence))

FDMN_Only <- FDMN_Only %>% 
  mutate (`30_day_outcome`=ifelse(`30_day_outcome`=="Recoverd", "Recovered",`30_day_outcome`))
```

```{r, include=FALSE, message = FALSE}

#Testing and positivity

ARI_ILI_Pos <-ari_ili %>%
  select(case_id, sample_type, date_of_case_detection, health_facility_name, camp, block, upazila, laboratory_result, nationality) 

#Keep only positive and negatives for positivity by week 
ARI_ILI_Pos<-filter(ARI_ILI_Pos, laboratory_result == "Positive" | laboratory_result == "Negative")
ARI_ILI_Pos<-filter(ARI_ILI_Pos, nationality=="FDMN")

#Remove follow ups
ARI_ILI_Pos<-filter(ARI_ILI_Pos, sample_type!= "Follow-up")
# removed 227 samples

#Add in ISOweek
ARI_ILI_Pos$Week<-ISOweek(ARI_ILI_Pos$date_of_case_detection)

TestCamps<-ARI_ILI_Pos %>%
  group_by(camp, nationality) %>%
  summarise(n=n())

TestCamps<- TestCamps%>%
  adorn_totals("row")

# number positives and negatives by week and camp
ARI_ILI_Pos2<-ARI_ILI_Pos %>% 
  group_by(camp, laboratory_result) %>%
  summarise(n=n())%>%
  spread(laboratory_result, n)

#Overall positivity by camp
ARI_ILI_Pos2$positivity<-round(ARI_ILI_Pos2$Positive/(ARI_ILI_Pos2$Negative+ARI_ILI_Pos2$Positive)*100, 1)

#Left joining with the number of tests
ARI_ILI_CampTable<-left_join(ARI_ILI_Pos2,TestCamps, by ="camp" )

#Adding totals
ARI_ILI_CampTable<-ARI_ILI_CampTable %>% 
  adorn_totals("row")

#creating a flextable ordering positivity from high to low
ARI_ILI_Pos_SummaryCampOrdered<-ARI_ILI_CampTable[order(ARI_ILI_CampTable$positivity, na.last = T, decreasing = T),-5]

Report_ARI_ILI_CampTable<-flextable(ARI_ILI_Pos_SummaryCampOrdered)

Report_ARI_ILI_CampTable<-autofit(Report_ARI_ILI_CampTable) %>% 
  set_header_labels(camp = "Camp (Residence)",
                    n = "Total tests",
                    positivity = "Positivity") %>%
  bold(bold = TRUE, part = "header")

Report_ARI_ILI_CampTable<- fontsize(Report_ARI_ILI_CampTable, size = 10, part="all") 
Report_ARI_ILI_CampTable<-autofit(Report_ARI_ILI_CampTable)

#Testing in total
FDMN_Test<-as.integer(sum(TestingClean$fdmn))
Host_Test<-as.integer(sum(TestingClean$host))

# #Testing in the last 7 days
#Making a % positive
FDMNPos<- TestingClean[, c(1,4,5)]
FDMNPos$Positivity<-round(FDMNPos$fdmn_positive/FDMNPos$fdmn*100, 1)

FDMNOverallPos<- FDMNPos %>%
  summarise(total_tests = sum(fdmn, na.rm=TRUE),
             total_cases = sum(fdmn_positive, na.rm=TRUE)) %>%
              mutate(Overall_Pos = round(as.numeric(total_cases/total_tests*100), 1))

FDMNOverallPosNum<-FDMNOverallPos$Overall_Pos

FDMNPos$date<-as.Date(FDMNPos$date)

FDMNPositvity7day<- FDMNPos %>%
  filter(date >  today()- 7) %>%
  summarise(total_tests_7days = sum(fdmn, na.rm=TRUE),
             total_cases_7days = sum(fdmn_positive, na.rm=TRUE)) %>%
              mutate(WeekPositivty = round(as.numeric(total_cases_7days/total_tests_7days*100), 1))

# Tests in the last week - FDMN
#Filter for tests done last week 
ARI_ILI_Pos_Week_FDMN<-ARI_ILI_Pos %>% 
  filter(Week == LastWeek) %>%
  filter(nationality == "FDMN")

# Test in the last week and positivity in the last week
n_Tests_Week_FDMN<-nrow(ARI_ILI_Pos_Week_FDMN)
WeekPositivity<-FDMNPositvity7day$WeekPositivty

# Number of tests done by camp
TestCampsWeek<-ARI_ILI_Pos_Week_FDMN %>%
  group_by(camp) %>%
  summarise(n=n())
TestCampsWeek<- TestCampsWeek

# number positives and negatives by week and camp
ARI_ILI_Pos_Week2<-ARI_ILI_Pos_Week_FDMN %>% 
  group_by(camp, laboratory_result) %>%
  summarise(n=n())%>%
  spread(laboratory_result, n)

#Overall positivity by camp
ARI_ILI_Pos_Week2$positivity<-round(ARI_ILI_Pos_Week2$Positive/(ARI_ILI_Pos_Week2$Negative + ARI_ILI_Pos_Week2$Positive)*100, 1)

#Left joining with the number of tests
Week_ARI_ILI_CampTable<-left_join(ARI_ILI_Pos_Week2,TestCampsWeek, by ="camp" )

#creating a flextable ordering positivity from high to low
Week_Camp<-Week_ARI_ILI_CampTable[order(Week_ARI_ILI_CampTable$positivity, na.last = T, decreasing = T),] 

#Filtering for cases by camp in the last week 
WeekCamp2<-
  filter(Week_Camp, Positive >=1)

Week_CampFlex<-flextable(WeekCamp2)

Week_CampFlex<-autofit(Week_CampFlex) %>% 
  set_header_labels(camp = "Camp of Residence",
                    n = "Total tests - last 7 days",
                    positivity = "Positivity") %>%
  bold(bold = TRUE, part = "header")

Week_CampFlex<- fontsize(Week_CampFlex, size = 10, part="all") 
Week_CampFlex_Report<-autofit(Week_CampFlex)

```
<div custom-style = "subtitle">`r params$subtitle`</div>
<div custom-style = "centre">`r params$date`</div>

# Introduction

This situation report  covers the surveillance of **`r params$organism`** in Cox's Bazar, Bangladesh. 

* This SitRep provides an update as of **`r format(Sys.time(), '%d %B, %Y')`**.
* The data in this reports covers only the **Forcibly Displaced Myanmar Nationals (FDMN)/Rohingya Refugee** population.


# Executive Summary

As of **`r format(Sys.time(), '%d %B, %Y')`** a total of **`r (n_cases_FDMN)`** individuals from the FDMN/Rohingya Refugee population have been confirmed as having `r params$organism`. 

* This week (`r ThisWeek`) there have been **`r DifferenceLastWeek`** new cases since last week (`r LastWeek`)

*  **`r CampsWithCases`** camps have reported cases 
* There have been **`r deathscount` deaths** int the FDMN/Rohingya Refugee population
* The **case fatality rate** is `r CRF`% 
* There were **`r n_Tests_Week_FDMN`** done in the FDMN/Rohingya Refugee population last week (`r LastWeek`)
* The positivity of tests done in the FDMN/Rohingya Refugee population last week was **`r WeekPositivity`**%


```{r, message = FALSE}
# Epicurve - overall 

FDMN_Only$count <- 1
FDMN_Only$ISOweekshort <- gsub('.{2}$', '',FDMN_Only$ISOweek)
 summary_isoweek <- aggregate(FDMN_Only$count, by = list(FDMN_Only$ISOweekshort), FUN =sum)

Epicurve<-
  ggplot(summary_isoweek, aes(x=Group.1, y=x)) +
  geom_col(position="stack", fill = "#ED7D31") +
  theme_minimal() +
  theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.text=element_text(size=8),
        axis.title=element_text(size=8,face="bold")) + 
  labs(x = "Week of specimen collection", y = "Number of cases") +
  ggtitle("Figure 1: Confirmed cases by specimen collection week (FDMN/ Rohingya Refugees)") + theme(plot.title = element_text(size=10))

Epicurve

```

# Cases in the last week - FDMN/Rohingya Refugees 

* There have been **`r DifferenceLastWeek`** new cases in the FDMN/Rohingya Refugee population, since last week . 

* There have been **`r n_Tests_Week_FDMN`** tests undertaken in the last week.

```{r, include=FALSE, message = FALSE}
# Generate a line list of cases in the last week table to add 
LastWeekCasesCAMP<- FDMN_Only %>% 
  group_by(camp_of_residence) %>% 
  filter(ISOweek >=(LastWeek))

# Male and Female breakdown 
SexWeek<- LastWeekCasesCAMP %>%
  group_by(sex, .drop=FALSE) %>%
  summarise(count=n())

# Cases split by sex
LastWeekMale<-SexWeek[2,2]
LastWeekFemale<-SexWeek[1,2]

#Male and Female - %s
Male_Prop_Week<-round(sum(LastWeekMale/(LastWeekMale+LastWeekFemale)*100), 1)
Female_Prop_Week<-round(sum(LastWeekFemale/(LastWeekMale+LastWeekFemale)*100), 1)

# Epicurve for the last week 

LastWeekEpicurve<-
  ggplot(LastWeekCasesCAMP, aes(x=date_of_specimen_collection, y=count, fill=camp_of_residence)) +
  geom_col(position="stack") +
  theme_minimal() +
  theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.text=element_text(size=8),
        axis.title=element_text(size=8,face="bold")) +
  labs(x = "Week of specimen collection", y = "Number of cases") +
  ggtitle("Figure 2: Confirmed cases last week by camp (FDMN/ Rohingya Refugees)") + theme(plot.title = element_text(size=11)) +
   scale_fill_discrete(name="Camp of Residence")

LastWeekEpicurve

```

## Camp of residence of cases reported in the last 7 days (FDMN/Rohingya Refugees)

```{r}
LastWeekEpicurve
```

## Age and sex breakdown of cases reported in the last 7 days (FDMN/Rohingya Refugees)

* There were **`r LastWeekMale`** male (`r Male_Prop_Week`%) and **`r LastWeekFemale`**  female (`r Female_Prop_Week`%) cases last week

```{r ageandsexplot_week, echo=FALSE, warning=FALSE, message=FALSE}
AgeSex_Week<-
  ggplot(LastWeekCasesCAMP,aes(x=agegp, fill=sex)) +
            geom_bar(data=subset(LastWeekCasesCAMP,sex=="F"), color="white", width=1) +
            geom_bar(data=subset(LastWeekCasesCAMP,sex=="M"), aes(y=..count..*(-1)), color="white", width=1) +
            theme_minimal() +
            xlab("Age group") +
            scale_y_continuous(breaks=seq(-10,10,1),labels=abs(seq(-10,10,1))) +
            scale_x_discrete(limits=levels(LastWeekCasesCAMP$agegp)) +
            geom_hline(yintercept=0) + 
            coord_flip() +
           theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank()) +
 ggtitle("Figure 3: Confirmed cases in the last week - age and sex pyramid") + 
  theme(plot.title = element_text(size=10))+
  scale_fill_discrete(name="Sex")

AgeSex_Week
```

## Positivity and testing by camp in the last 7 days (FDMN/Rohingya Refugees only)

* This table includes only **positive** and **negative** results for the week `r LastWeek`, entered on to the ARI/ILI line list. Follow up tests are not included.

`r Week_CampFlex_Report`

# Descriptive Epidemiology - Cumulative 

## Age and Sex breakdown

* The overall median age of cases is **`r medianage`** (range **`r RangeLow` - `r RangeUpper`** years old)
* In total, there have been **`r Male`** (`r Male_Prop`%) male cases and **`r Female`** (`r Female_Prop`%) female cases

### Epidemic Curve by Sex:
```{r} 
summary_Sex <- aggregate(FDMN_Only$count, by = list(FDMN_Only$sex, FDMN_Only$ISOweekshort), FUN =sum)

EpicurveSex<-
  ggplot(summary_Sex, aes(x=Group.2, y=x, fill=Group.1)) +
  geom_col() +
  theme_minimal() +
  theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.text=element_text(size=8),
        axis.title=element_text(size=8,face="bold")) + 
  labs(x = "Week of specimen collection", y = "Number of cases") +
  ggtitle("Figure 2: Confirmed cases by specimen collection week (FDMN/ Rohingya Refugees) by sex") + 
  theme(plot.title = element_text(size=10))+
  scale_fill_discrete(name="Sex")

EpicurveSex


```

### Age and Sex Pyramid - confirmed cases FDMN/Rohingya Refugee

```{r ageandsexplot, echo=FALSE, warning=FALSE, message=FALSE}
AgeSex<-
ggplot(FDMN_Only,aes(x=agegp, fill=sex)) +
            geom_bar(data=subset(FDMN_Only,sex=="F"), color="white", width=1) +
            geom_bar(data=subset(FDMN_Only,sex=="M"), aes(y=..count..*(-1)), color="white", width=1) +
            theme_minimal() +
            xlab("Age group") +
            scale_y_continuous(breaks=seq(-10,10,1),labels=abs(seq(-10,10,1))) +
            scale_x_discrete(limits=levels(FDMN_Only$agegp)) +
            geom_hline(yintercept=0) + 
            coord_flip() +
           theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank(), legend.title=element_blank())

AgeSex
```

## Severity of reported cases 

<br>

```{r}
Summary_Severity<- FDMN_Only %>%
  group_by(severity_of_disease) %>%
  summarise(count=n())

Summary_Severity<- Summary_Severity%>%
  adorn_totals("row")

Proportions<-round(Summary_Severity$count/ n_cases_FDMN *100, 2)
Summary_Severity['Percentage'] = Proportions

Summary_Severity_Flex<-flextable(Summary_Severity)

Table1<-Summary_Severity_Flex %>%
set_header_labels(severity_of_disease = "Severity of Disease",
                  count = "Frequency",
                  Percentage = "Percentage of total (%)") %>%
bold(bold = TRUE, part = "header")
Table1<-autofit(Table1)
Table1<- fontsize(Table1, size = 10, part="all") 

Table1

# Epidemic curve by severity

summary_severity <- aggregate(FDMN_Only$count, by = list(FDMN_Only$ISOweekshort, FDMN_Only$severity_of_disease), FUN =sum)

SeverityEpicurve<-
  ggplot(FDMN_Only, aes(x=ISOweekshort, y=count, fill=severity_of_disease)) +
  geom_col(position="stack") +
  theme_minimal() +
    scale_fill_manual(values=c("yellow", "red", "forest green", "dark orange", "dark grey")) +
  theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.text=element_text(size=8),
        axis.title=element_text(size=8,face="bold")) +
  labs(x = "Week of specimen collection", y = "Number of cases") +
  ggtitle("Figure 3: Confirmed cases last week by severity (FDMN/ Rohingya Refugees)") + theme(plot.title = element_text(size=10))

SeverityEpicurve

```
<br> 

## Outcomes at 30 days  

As of **`r format(Sys.time(), '%d %B, %Y')`** there have been **`r deathscount`** deaths in the FDMN/Rohingya Refugee population tested in Cox's Bazar  
<br>
<br>
Table 1: Severity of disease and outcome at 30 days (cumulative)
<br>
<br>
```{r}
Sum_tab_Severity<-as.data.frame(table(FDMN_Only$`30_day_outcome`, FDMN_Only$severity_of_disease))
names(Sum_tab_Severity) <- c('Severity of disease','Outcome at 30 days', 'count')

Sum_tab_Severity2<-flextable(Sum_tab_Severity)
Sum_tab_Severity2<-autofit(Sum_tab_Severity2)
Sum_tab_Severity2<- fontsize(Sum_tab_Severity2, size = 10, part="all") 


DeathsAsymp<-Sum_tab_Severity[1,3]
DeatsCritical <-Sum_tab_Severity[4,3]
DeathsSevere<-Sum_tab_Severity[10,3]
DeathsMildModerate	<-Sum_tab_Severity[7,3]
DeathsUnknown<-Sum_tab_Severity[13,3]

Sum_tab_Severity2  

```
<br>
<br>
* There were **`r DeathsUnknown`** deaths for individuals for whom the severity of symptoms was **unknown**

## Residence of cases and cases per 100,000

There are 20 sentinel sites at which testing for `r params$organism` is available as of **`r format(Sys.time(), '%d %B, %Y')`** across Cox's Bazar

```{r}
CasesCampTable<-CasesCamp[order(-CasesCamp$count), ]

CasesCampTable<-flextable(CasesCampTable)
CasesCampTable<-autofit(CasesCampTable)

# Number of cases by camp
CasesCamp<- FDMN_Only %>%
  group_by(camp_of_residence) %>%
  summarise(count=n())

# Remove the word "camp" from the population data to allow merges
population<-population %>%
  mutate(camp_of_residence = gsub("Camp", "", New_Camp_Name))

#triming white space in the dataframe
population$camp_of_residence<-trimws(population$camp_of_residence, which = c("both", "left", "right"), whitespace = "[ \t\r\n]")

#Merge the CasesCamp and Population data together
TablePop<- left_join(population, CasesCamp, by="camp_of_residence")

#Generate the rates per 100,000 and add to the Table Pop dataframe
Ratesper100k<-round(TablePop$count/TablePop$Total_Pop*100000, 1)
TablePop$Ratesper100k<-Ratesper100k

#Sort from high to low based on rates per 100,000
TablePopOrdered<-TablePop[order(TablePop$Ratesper100k, na.last= TRUE, decreasing = TRUE),]

#Replace NA with 0 for count and for rate
TablePopOrdered$count[is.na(TablePopOrdered$count)] = 0
TablePopOrdered$Ratesper100k[is.na(TablePopOrdered$Ratesper100k)] = 0

#Make a table with just the necessary information to present
TableReport<- TablePopOrdered[,c(2,6,10,14,15)]

#FlexTable for the R output
Table_AttackRates<-flextable(TableReport)
Table_AttackRates<-autofit(Table_AttackRates) %>% 
  set_header_labels(New_Camp_Name = "Camp of Residence",
                  Total_Pop = "Population",
                  count = "Cases",
                  Ratesper100k = "Rate per 100k") %>%
  bold(bold = TRUE, part = "header")


Table_AttackRates<- fontsize(Table_AttackRates, size = 10, part="all") 
Table_AttackRates<-autofit(Table_AttackRates)

```

Figure 3: Cases and rates per 100,000 by reported camp of residence as of **`r format(Sys.time(), '%d %B, %Y')`**
<br>
<br>
`r Table_AttackRates`


# Testing

```{r,warnings=FALSE}
library(ggplot2)
library(lubridate)

test_nationality<-test_nationality %>%
  mutate(date_test = ymd(test_nationality$date_format))

# Graph for testing the FDMN population

FDMN_Test_graph<-test_nationality %>% 
  filter(name %in% c('fdmn', 'fdmn_positive')) %>%
   mutate(name_fac=factor(name, levels = c('fdmn', 'fdmn_positive'),
                        labels=c('Tests', 'Cases'))) %>%
ggplot(., aes(x=as.Date(date_test), y=as.numeric(value), fill=name_fac)) +
           geom_bar(stat="identity") +
           scale_x_date(date_breaks= '30 day', date_minor_breaks = '7 day',
                        date_labels = '%d-%m') +
           labs(caption = "Data source: Sentinel Surveillance",
                x="Date",
                y= "count",
                fill="") +
           theme_minimal()

```

## Positivity
```{r, include=FALSE}
#install.packages("plotrix")

library(plotrix)

#Making a % positive
FDMNPos<- TestingClean[, c(1,4,5)]
FDMNPos$Positivity<-round(FDMNPos$fdmn_positive/FDMNPos$fdmn*100, 1)

FDMNOverallPos<- FDMNPos %>%
  summarise(total_tests = sum(fdmn, na.rm=TRUE),
             total_cases = sum(fdmn_positive, na.rm=TRUE)) %>%
              mutate(Overall_Pos = round(as.numeric(total_cases/total_tests*100), 1))

FDMNOverallPosNum<-FDMNOverallPos$Overall_Pos

FDMNPos$date<-as.Date(FDMNPos$date)

```

* **`r FDMN_Test`** tests have been done in the FDMN/Rohingya Refugee population since `r first_date`.

* The overall posivitiy of tests undertaken in the FDMN/Rohingya Refugee population, since the start of testing, was **`r FDMNOverallPosNum`%** 

<br>
<br>

```{r, warning=FALSE}
FDMN_Test_graph
```
<br>

### Positivity and testing by camp 
Positivity refers to the proportion of tests which were positive (positive tests/all tests). 

* This table includes only **positive** and **negative** results for the period **`r first_date`** to **`r last_date`** and which are entered on to the ARI/ILI line list

* This table does not include follow up test results
* This data includes results for testing in the FDMN/Rohingya Refugee population only. 

`r Report_ARI_ILI_CampTable`

```{r Map}

```

# Further information 
  
## Case Definitions
### Syndromic case definition 


An individual with:  

Uncomplicated upper respiratory tract viral infection symptoms such as fever AND at least one of their sign/symptom including:

*	Cough (with or without sputum production)
*	Shortness of breath (dyspnoea)
*	Fatigue, malaise, muscle pain, sore throat, dyspnoea, nasal congestion, or headache.  

Patients may also present with diarrhoea, nausea, and vomiting.

## Time Lags

* Please note:  there may be time lags between data entered on the syndromic surveillance database, and other sources of data (including Go.Data).


# Appendix 1 - Testing in the Host population

``` {r}

# Graph for testing the host population

Host_Test_graph<-test_nationality %>% 
  filter(name %in% c('host', 'host_positive')) %>%
   mutate(name_fac=factor(name, levels = c('host', 'host_positive'),
                        labels=c('Tests', 'Cases'))) %>%
ggplot(., aes(x=as.Date(date_test), y=as.numeric(value), fill=name_fac)) +
           geom_bar(stat="identity") +
           scale_x_date(date_breaks= '30 day', date_minor_breaks = '7 day',
                        date_labels = '%d-%m') +
           labs(caption = "Data source: Sentinel Surveillance_Host",
                x="Date",
                y= "count",
                fill="") +
           theme_minimal()

Host_Test_graph